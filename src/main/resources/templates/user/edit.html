<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/defaultLayout}">

<head>
    <title layout:title-pattern="$CONTENT_TITLE">ì‚¬ìš©ì ìˆ˜ì •</title>
</head>

<th:block layout:fragment="Content">
    <div style="padding: 20px; max-width: 600px; margin: 0 auto;">
        <h2>âœï¸ ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •</h2>
        
        <!-- ì‚¬ìš©ì ì •ë³´ ë¡œë”© ì¤‘ ë©”ì‹œì§€ -->
        <div id="loadingMessage" style="text-align: center; padding: 50px; display: block;">
            â³ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>

        <form id="userForm" style="background-color: #f8f9fa; padding: 30px; border-radius: 8px; border: 1px solid #ddd; display: none;">
            
            <!-- ì‚¬ìš©ì ID (ìˆ¨ê¹€) -->
            <input type="hidden" id="userId" name="userId">
            
            <!-- ì‚¬ìš©ì ì •ë³´ í‘œì‹œ -->
            <div style="background-color: #e9ecef; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <p style="margin: 0; color: #6c757d;">
                    <strong>ì‚¬ìš©ì ID:</strong> <span id="displayUserId"></span> | 
                    <strong>ë“±ë¡ì¼:</strong> <span id="displayCreatedAt"></span>
                </p>
            </div>

            <!-- ì‚¬ìš©ìëª… ì…ë ¥ -->
            <div style="margin-bottom: 20px;">
                <label for="username" style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ‘¤ ì‚¬ìš©ìëª… *</label>
                <input type="text" id="username" name="username" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                       placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                <small style="color: #6c757d;">2-50ì ì´ë‚´, ì˜ë¬¸/í•œê¸€/ìˆ«ì ê°€ëŠ¥</small>
            </div>

            <!-- ì´ë©”ì¼ ì…ë ¥ -->
            <div style="margin-bottom: 20px;">
                <label for="email" style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ“§ ì´ë©”ì¼ *</label>
                <input type="email" id="email" name="email" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                       placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                <small style="color: #6c757d;">ì˜ˆ: user@example.com</small>
            </div>

            <!-- ì „í™”ë²ˆí˜¸ ì…ë ¥ -->
            <div style="margin-bottom: 30px;">
                <label for="phone" style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ“ ì „í™”ë²ˆí˜¸</label>
                <input type="tel" id="phone" name="phone"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                       placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)">
                <small style="color: #6c757d;">ì˜ˆ: 010-1234-5678</small>
            </div>

            <!-- ë²„íŠ¼ ì˜ì—­ -->
            <div style="text-align: center;">
                <button type="button" onclick="updateUser()" 
                        style="padding: 12px 30px; background-color: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                    âœ… ìˆ˜ì •í•˜ê¸°
                </button>
                <button type="button" onclick="location.href='/user/list'" 
                        style="padding: 12px 30px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    â†©ï¸ ëª©ë¡ìœ¼ë¡œ
                </button>
            </div>
        </form>

        <!-- ì—ëŸ¬ ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="errorMessage" style="text-align: center; padding: 50px; color: #dc3545; display: none;">
            âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            <br><br>
            <button onclick="location.href='/user/list'" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="messageArea" style="margin-top: 20px; padding: 15px; border-radius: 4px; display: none;">
        </div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œì‹œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        window.onload = function() {
            const pathParts = window.location.pathname.split('/');
            const userId = pathParts[pathParts.length - 1];
            
            if (!userId || isNaN(userId)) {
                showError();
                return;
            }

            loadUserInfo(userId);
        };

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        function loadUserInfo(userId) {
            fetch(`/api/users/${userId}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                })
                .then(user => {
                    displayUserInfo(user);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError();
                });
        }

        // ì‚¬ìš©ì ì •ë³´ í™”ë©´ì— í‘œì‹œ
        function displayUserInfo(user) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('userForm').style.display = 'block';

            // í¼ì— ë°ì´í„° ì„¤ì •
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('phone').value = user.phone || '';

            // ì •ë³´ í‘œì‹œ ì˜ì—­
            document.getElementById('displayUserId').textContent = user.id;
            document.getElementById('displayCreatedAt').textContent = formatDate(user.createdAt);
        }

        // ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •
        function updateUser() {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!username) {
                showMessage('ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('username').focus();
                return;
            }

            if (username.length < 2 || username.length > 50) {
                showMessage('ì‚¬ìš©ìëª…ì€ 2-50ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('username').focus();
                return;
            }

            if (!email) {
                showMessage('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('email').focus();
                return;
            }

            if (!isValidEmail(email)) {
                showMessage('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('email').focus();
                return;
            }

            // ì—…ë°ì´íŠ¸ ë°ì´í„° ì¤€ë¹„
            const updateData = {
                username: username,
                email: email,
                phone: phone || null
            };

            // ì„œë²„ì— ì „ì†¡
            showMessage('ìˆ˜ì • ì¤‘...', 'info');
            
            fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 404) {
                    throw new Error('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                } else if (response.status === 409) {
                    throw new Error('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìëª… ë˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.');
                } else {
                    throw new Error('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .then(data => {
                showMessage(`âœ… ì‚¬ìš©ì '${data.username}'ì˜ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                
                // 3ì´ˆ í›„ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
                setTimeout(() => {
                    location.href = '/user/list';
                }, 2000);
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('âŒ ' + error.message, 'error');
            });
        }

        // ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
        function showError() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.style.display = 'block';
            messageArea.textContent = message;
            
            // íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
            if (type === 'success') {
                messageArea.style.backgroundColor = '#d4edda';
                messageArea.style.color = '#155724';
                messageArea.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                messageArea.style.backgroundColor = '#f8d7da';
                messageArea.style.color = '#721c24';
                messageArea.style.border = '1px solid #f5c6cb';
            } else if (type === 'info') {
                messageArea.style.backgroundColor = '#d1ecf1';
                messageArea.style.color = '#0c5460';
                messageArea.style.border = '1px solid #bee5eb';
            }
        }

        // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
        }

        // ì—”í„°í‚¤ë¡œ í¼ ì œì¶œ
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                e.preventDefault();
                updateUser();
            }
        });

        // ì „í™”ë²ˆí˜¸ ì…ë ¥ í¬ë§·íŒ… (ì„ íƒì‚¬í•­)
        document.addEventListener('DOMContentLoaded', function() {
            const phoneInput = document.getElementById('phone');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^0-9]/g, '');
                    if (value.length >= 3 && value.length <= 7) {
                        value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
                    } else if (value.length >= 8) {
                        value = value.replace(/(\d{3})(\d{4})(\d{1,4})/, '$1-$2-$3');
                    }
                    e.target.value = value;
                });
            }
        });
    </script>
</th:block>
</html>