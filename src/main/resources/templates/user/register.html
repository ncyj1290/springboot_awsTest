<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/defaultLayout}">

<head>
    <title layout:title-pattern="$CONTENT_TITLE">ì‚¬ìš©ì ë“±ë¡</title>
</head>

<th:block layout:fragment="Content">
    <div style="padding: 20px; max-width: 600px; margin: 0 auto;">
        <h2>â• ìƒˆ ì‚¬ìš©ì ë“±ë¡</h2>
        
        <form id="userForm" style="background-color: #f8f9fa; padding: 30px; border-radius: 8px; border: 1px solid #ddd;">
            
            <!-- ì‚¬ìš©ìëª… ì…ë ¥ -->
            <div style="margin-bottom: 20px;">
                <label for="username" style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ‘¤ ì‚¬ìš©ìëª… *</label>
                <input type="text" id="username" name="username" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                       placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                <small style="color: #6c757d;">2-50ì ì´ë‚´, ì˜ë¬¸/í•œê¸€/ìˆ«ì ê°€ëŠ¥</small>
            </div>

            <!-- ì´ë©”ì¼ ì…ë ¥ -->
            <div style="margin-bottom: 20px;">
                <label for="email" style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ“§ ì´ë©”ì¼ *</label>
                <input type="email" id="email" name="email" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                       placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                <small style="color: #6c757d;">ì˜ˆ: user@example.com</small>
            </div>

            <!-- ì „í™”ë²ˆí˜¸ ì…ë ¥ -->
            <div style="margin-bottom: 30px;">
                <label for="phone" style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ“ ì „í™”ë²ˆí˜¸</label>
                <input type="tel" id="phone" name="phone"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                       placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)">
                <small style="color: #6c757d;">ì˜ˆ: 010-1234-5678</small>
            </div>

            <!-- ë²„íŠ¼ ì˜ì—­ -->
            <div style="text-align: center;">
                <button type="button" onclick="submitForm()" 
                        style="padding: 12px 30px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                    âœ… ë“±ë¡í•˜ê¸°
                </button>
                <button type="button" onclick="location.href='/user/list'" 
                        style="padding: 12px 30px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    â†©ï¸ ëª©ë¡ìœ¼ë¡œ
                </button>
            </div>
        </form>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="messageArea" style="margin-top: 20px; padding: 15px; border-radius: 4px; display: none;">
        </div>
    </div>

    <script>
        // í¼ ì œì¶œ ì²˜ë¦¬
        function submitForm() {
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!username) {
                showMessage('ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('username').focus();
                return;
            }

            if (username.length < 2 || username.length > 50) {
                showMessage('ì‚¬ìš©ìëª…ì€ 2-50ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('username').focus();
                return;
            }

            if (!email) {
                showMessage('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('email').focus();
                return;
            }

            if (!isValidEmail(email)) {
                showMessage('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                document.getElementById('email').focus();
                return;
            }

            // ì‚¬ìš©ì ë°ì´í„° ì¤€ë¹„
            const userData = {
                username: username,
                email: email,
                phone: phone || null
            };

            // ì„œë²„ì— ì „ì†¡
            showMessage('ë“±ë¡ ì¤‘...', 'info');
            
            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (response.status === 201) {
                    return response.json();
                } else if (response.status === 409) {
                    throw new Error('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìëª… ë˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.');
                } else {
                    throw new Error('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .then(data => {
                showMessage(`âœ… ì‚¬ìš©ì '${data.username}'ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                
                // 3ì´ˆ í›„ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
                setTimeout(() => {
                    location.href = '/user/list';
                }, 2000);
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('âŒ ' + error.message, 'error');
            });
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.style.display = 'block';
            messageArea.textContent = message;
            
            // íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
            if (type === 'success') {
                messageArea.style.backgroundColor = '#d4edda';
                messageArea.style.color = '#155724';
                messageArea.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                messageArea.style.backgroundColor = '#f8d7da';
                messageArea.style.color = '#721c24';
                messageArea.style.border = '1px solid #f5c6cb';
            } else if (type === 'info') {
                messageArea.style.backgroundColor = '#d1ecf1';
                messageArea.style.color = '#0c5460';
                messageArea.style.border = '1px solid #bee5eb';
            }
        }

        // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // ì—”í„°í‚¤ë¡œ í¼ ì œì¶œ
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                e.preventDefault();
                submitForm();
            }
        });

        // ì „í™”ë²ˆí˜¸ ì…ë ¥ í¬ë§·íŒ… (ì„ íƒì‚¬í•­)
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length >= 3 && value.length <= 7) {
                value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
            } else if (value.length >= 8) {
                value = value.replace(/(\d{3})(\d{4})(\d{1,4})/, '$1-$2-$3');
            }
            e.target.value = value;
        });
    </script>
</th:block>
</html>