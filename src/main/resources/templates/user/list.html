<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/defaultLayout}">

<head>
    <title layout:title-pattern="$CONTENT_TITLE">ì‚¬ìš©ì ëª©ë¡</title>
</head>

<th:block layout:fragment="Content">
    <div style="padding: 20px;">
        <h2>ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</h2>
        
        <!-- ê²€ìƒ‰ ë° ì¶”ê°€ ë²„íŠ¼ ì˜ì—­ -->
        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <input type="text" id="searchKeyword" placeholder="ì‚¬ìš©ìëª…ìœ¼ë¡œ ê²€ìƒ‰..." style="padding: 8px; width: 200px;">
                <button onclick="searchUsers()" style="padding: 8px 15px; background-color: #007bff; color: white; border: none; cursor: pointer;">ğŸ” ê²€ìƒ‰</button>
                <button onclick="loadAllUsers()" style="padding: 8px 15px; background-color: #6c757d; color: white; border: none; cursor: pointer;">ğŸ“‹ ì „ì²´ëª©ë¡</button>
            </div>
            <div>
                <button onclick="location.href='/user/register'" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; cursor: pointer; font-weight: bold;">â• ìƒˆ ì‚¬ìš©ì ë“±ë¡</button>
            </div>
        </div>

        <!-- ì‚¬ìš©ì ëª©ë¡ í…Œì´ë¸” -->
        <table id="userTable" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
            <thead style="background-color: #f8f9fa;">
                <tr>
                    <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">ID</th>
                    <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">ì‚¬ìš©ìëª…</th>
                    <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">ì´ë©”ì¼</th>
                    <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">ì „í™”ë²ˆí˜¸</th>
                    <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">ìƒì„±ì¼</th>
                    <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- ì‚¬ìš©ì ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </tbody>
        </table>

        <!-- ë¡œë”© ë° ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="loadingMessage" style="text-align: center; padding: 20px; display: none;">
            â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
        
        <div id="noDataMessage" style="text-align: center; padding: 20px; color: #6c757d; display: none;">
            ğŸ“­ ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œì‹œ ì „ì²´ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
        window.onload = function() {
            loadAllUsers();
        };

        // ì „ì²´ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
        function loadAllUsers() {
            showLoading(true);
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    displayUsers(data);
                    showLoading(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    showLoading(false);
                });
        }

        // ì‚¬ìš©ì ê²€ìƒ‰
        function searchUsers() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            if (!keyword) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            showLoading(true);
            fetch(`/api/users/search?keyword=${encodeURIComponent(keyword)}`)
                .then(response => response.json())
                .then(data => {
                    displayUsers(data);
                    showLoading(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    showLoading(false);
                });
        }

        // ì‚¬ìš©ì ëª©ë¡ í™”ë©´ì— í‘œì‹œ
        function displayUsers(users) {
            const tableBody = document.getElementById('userTableBody');
            const noDataMessage = document.getElementById('noDataMessage');

            if (users.length === 0) {
                tableBody.innerHTML = '';
                noDataMessage.style.display = 'block';
                return;
            }

            noDataMessage.style.display = 'none';
            
            tableBody.innerHTML = users.map(user => `
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="border: 1px solid #ddd; padding: 10px;">${user.id}</td>
                    <td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">${user.username}</td>
                    <td style="border: 1px solid #ddd; padding: 10px;">${user.email}</td>
                    <td style="border: 1px solid #ddd; padding: 10px;">${user.phone || '-'}</td>
                    <td style="border: 1px solid #ddd; padding: 10px;">${formatDate(user.createdAt)}</td>
                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">
                        <button onclick="editUser(${user.id})" style="padding: 5px 10px; background-color: #ffc107; color: black; border: none; cursor: pointer; margin-right: 5px;">âœï¸ ìˆ˜ì •</button>
                        <button onclick="deleteUser(${user.id}, '${user.username}')" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; cursor: pointer;">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </td>
                </tr>
            `).join('');
        }

        // ì‚¬ìš©ì ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
        function editUser(userId) {
            location.href = `/user/edit/${userId}`;
        }

        // ì‚¬ìš©ì ì‚­ì œ
        function deleteUser(userId, username) {
            if (!confirm(`'${username}' ì‚¬ìš©ìë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            fetch(`/api/users/${userId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert('ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadAllUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ë¡œë”© ìƒíƒœ í‘œì‹œ/ìˆ¨ê¹€
        function showLoading(show) {
            const loadingMessage = document.getElementById('loadingMessage');
            const userTable = document.getElementById('userTable');
            
            if (show) {
                loadingMessage.style.display = 'block';
                userTable.style.display = 'none';
            } else {
                loadingMessage.style.display = 'none';
                userTable.style.display = 'table';
            }
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
        }

        // ê²€ìƒ‰ ì…ë ¥ë€ì—ì„œ ì—”í„°í‚¤ ì²˜ë¦¬
        document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });
    </script>
</th:block>
</html>